<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Slide Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .perspective-1000 {
        perspective: 1000px;
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gray-50 text-gray-800 font-sans selection:bg-blue-100 overflow-x-hidden"
  >
    <header
      class="bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between sticky top-0 z-50"
    >
      <div class="flex items-center gap-2">
        <div
          class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white font-bold"
        >
          <i data-lucide="presentation" class="w-[18px] h-[18px]"></i>
        </div>
        <span class="font-bold text-lg tracking-tight">AI Slide Builder</span>
      </div>

      <nav class="flex items-center gap-8 hidden md:flex">
        <a
          href="#"
          class="text-blue-600 font-medium border-b-2 border-blue-600 pb-0.5"
          >Home</a
        >
      </nav>

      <button
        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-full font-medium text-sm transition-colors shadow-sm"
      >
        New deck
      </button>
    </header>

    <main class="max-w-7xl mx-auto px-4 pt-10 pb-20 flex flex-col items-center">
      <h1
        class="text-4xl md:text-5xl font-black text-gray-900 mb-8 tracking-tight text-center"
      >
        AI Slide Builder
      </h1>

      <div class="w-full max-w-2xl flex flex-col gap-4 mb-16 relative z-30">
        <input
          id="topicInput"
          type="text"
          placeholder="Explain quantum computing basics"
          class="w-full px-6 py-4 rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 shadow-sm text-gray-600 text-lg placeholder:text-gray-400 bg-white"
        />
        <button
          id="generateBtn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3.5 rounded-full shadow-md hover:shadow-lg transition-all transform active:scale-[0.99] text-lg"
        >
          <span id="generateText">Generate slides</span>
          <span
            id="spinner"
            class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"
          ></span>
        </button>
      </div>

      <div
        class="relative w-full h-[450px] flex items-center justify-center perspective-1000 mb-8"
      >
        <button
          id="prevBtn"
          class="absolute left-4 md:left-10 z-30 bg-white p-3 rounded-full shadow-lg border border-gray-100 text-gray-400 hover:text-blue-600 hover:border-blue-100 transition-all hover:scale-110 active:scale-95 cursor-pointer"
        >
          <i data-lucide="chevron-left" class="w-6 h-6"></i>
        </button>

        <div
          id="slides-container"
          class="relative w-full h-full flex items-center justify-center"
        ></div>

        <button
          id="nextBtn"
          class="absolute right-4 md:right-10 z-30 bg-white p-3 rounded-full shadow-lg border border-gray-100 text-gray-400 hover:text-blue-600 hover:border-blue-100 transition-all hover:scale-110 active:scale-95 cursor-pointer"
        >
          <i data-lucide="chevron-right" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 relative z-30">
        <button
          id="downloadPdfBtn"
          class="flex items-center gap-2 px-6 py-3 bg-white hover:bg-gray-50 text-gray-700 font-medium rounded-xl shadow-sm border border-gray-200 transition-all text-sm hover:-translate-y-0.5"
        >
          Download as PDF
        </button>
        <button
          id="downloadPngBtn"
          class="flex items-center gap-2 px-6 py-3 bg-white hover:bg-gray-50 text-gray-700 font-medium rounded-xl shadow-sm border border-gray-200 transition-all text-sm hover:-translate-y-0.5"
        >
          Download all slides as PNG
        </button>

        <button
          id="shareBtn"
          class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white font-medium rounded-xl shadow-sm transition-all text-sm hover:-translate-y-0.5"
        >
          Share
        </button>
      </div>

      <div
        id="loadingOverlay"
        class="fixed inset-0 bg-white/60 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300"
      >
        <div class="flex flex-col items-center gap-3">
          <div
            class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"
          ></div>
          <p class="text-gray-700 font-medium text-lg">Generating slidesâ€¦</p>
        </div>
      </div>
    </main>

    <script>
      const sharedSlides = {{shared_slides|default:"null"|safe}};
      const slidesData = sharedSlides || [
          {
              id: 0,
              title: "Introduction to Quantum Computing",
              image: "https://images.unsplash.com/photo-1635070041078-e363dbe005cb?auto=format&fit=crop&w=800&q=80",
          },
          {
              id: 1,
              title: "Quantum Superposition",
              image: "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&w=800&q=80",
          },
          {
              id: 2,
              title: "Quantum Entanglement",
              image: "https://images.unsplash.com/photo-1605647540924-852290f6b0d5?auto=format&fit=crop&w=800&q=80",
          },
          {
              id: 3,
              title: "Future of Computing",
              image: "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&w=800&q=80",
          },
          {
              id: 4,
              title: "Qubit Architecture",
              image: "https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=800&q=80",
          }
      ];

      let activeSlide = 1;
      const container = document.getElementById('slides-container');

      function init() {
          slidesData.forEach((slide, index) => {
              const slideEl = document.createElement('div');
              slideEl.id = `slide-${index}`;
              slideEl.className = "absolute w-[320px] md:w-[600px] h-[220px] md:h-[400px] bg-white rounded-2xl md:rounded-3xl shadow-xl overflow-hidden border border-gray-100 transition-all duration-500 ease-out transform";

              slideEl.innerHTML = `
                  <img
                      src="${slide.image}"
                      alt="${slide.title}"
                      class="w-full h-full object-cover"
                  />
                  <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-6 md:p-8 text-white">
                      <h3 class="text-xl md:text-3xl font-bold mb-2">${slide.title}</h3>
                      <p class="text-sm md:text-base text-gray-200 opacity-90">AI Generated Slide Preview</p>
                  </div>
                  <div class="absolute top-4 right-4 bg-white/20 backdrop-blur-md px-3 py-1 rounded-full border border-white/30">
                      <span class="text-xs font-semibold text-white">Slide ${index + 1}</span>
                  </div>
              `;
              container.appendChild(slideEl);
          });

          updateSlides();
      }

      function updateSlides() {
          const length = slidesData.length;

          slidesData.forEach((_, index) => {
              const el = document.getElementById(`slide-${index}`);
              let offset = (index - activeSlide + length) % length;
              if (offset > length / 2) offset -= length;

              let classes = "absolute w-[320px] md:w-[600px] h-[220px] md:h-[400px] bg-white rounded-2xl md:rounded-3xl shadow-xl overflow-hidden border border-gray-100 transition-all duration-500 ease-out transform ";

              if (offset === 0) {
                  classes += "z-20 scale-100 opacity-100 translate-x-0 shadow-2xl border-blue-100";
              } else if (offset === -1) {
                  classes += "z-10 scale-90 opacity-50 -translate-x-[280px] md:-translate-x-[350px] blur-[1px]";
              } else if (offset === 1) {
                  classes += "z-10 scale-90 opacity-50 translate-x-[280px] md:translate-x-[350px] blur-[1px]";
              } else {
                  classes += "z-0 scale-75 opacity-0 translate-x-0 pointer-events-none";
              }

              el.className = classes;
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
          const input = document.getElementById("topicInput");
          const generateBtn = document.getElementById("generateBtn");
          const downloaddPdfBtn = document.getElementById("downloadPdfBtn");
          const downloadPngBtn = document.getElementById("downloadPngBtn");
          const shareBtn = document.getElementById("shareBtn");
          init();
          lucide.createIcons();

          generateBtn.addEventListener("click", async () => {
              const topic = input.value.trim();
              if (!topic) return;

              generateBtn.disabled = true;
              document.getElementById("generateText").textContent = "Generating...";
              document.getElementById("spinner").classList.remove("hidden");
              document.getElementById("loadingOverlay").style.opacity = "1";
              document.getElementById("loadingOverlay").style.pointerEvents = "auto";


              try {
                  const response = await fetch('/api/generate_slides/', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ topic }),
                  });

                  const data = await response.json();
                  console.log('Respons data:', data);

                  if (data.slides && Array.isArray(data.slides)) {
                      slidesData.length = 0;
                      data.slides.forEach((s) => slidesData.push(s));
                      activeSlide = 0;

                      container.innerHTML = '';
                      init();
                  } else {
                      console.error('No slides in response');
                  }
              } catch (err) {
                  console.error("Error calling API", err);
              } finally {
                  generateBtn.disabled = false;
                  document.getElementById("spinner").classList.add("hidden");
                  document.getElementById("generateText").textContent = "Generate slides";
                  document.getElementById("loadingOverlay").style.opacity = "0";
                  document.getElementById("loadingOverlay").style.pointerEvents = "none";

              }
          });

          downloadPngBtn.addEventListener("click", () => {
              slidesData.forEach((slide, index) => {
                  if (!slide.image) return;

                  const link = document.createElement("a");
                  link.href = slide.image;
                  link.download = `slide_${index + 1}.png`;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
              });
          });

          downloadPdfBtn.addEventListener("click", () => {
              if (!window.jspdf) return;

              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF("landscape", "px", "a4");

              let firstPage = true;

              slidesData.forEach((slide) => {
                  if (!slide.image) return;

                  // only treat data urls as AI slides
                  if (!slide.image.startsWith("data:")) {
                      return;
                  }

                  const imgData = slide.image;
                  const imgProps = pdf.getImageProperties(imgData);
                  const pdfWidth = pdf.internal.pageSize.getWidth();
                  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                  const offsetY = (pdf.internal.pageSize.getHeight() - pdfHeight) / 2;
                  const format = imgData.includes("image/png") ? "PNG" : "JPEG";

                  if (!firstPage) {
                      pdf.addPage();
                  }
                  firstPage = false;

                  pdf.addImage(imgData, format, 0, offsetY, pdfWidth, pdfHeight);
              });

              pdf.save("ai_slides.pdf");
          });



          shareBtn.addEventListener("click", async () => {
              const response = await fetch("/api/share/", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ slides: slidesData }),
              });

              const data = await response.json();
              const code = data.code;
              const link = `${window.location.origin}/view/${code}`;

              alert("Share this link:\n\n" + link);
          });


      });

      document.getElementById('prevBtn').addEventListener('click', () => {
          activeSlide = (activeSlide - 1 + slidesData.length) % slidesData.length;
          updateSlides();
      });

      document.getElementById('nextBtn').addEventListener('click', () => {
          activeSlide = (activeSlide + 1) % slidesData.length;
          updateSlides();
      });
    </script>
  </body>
</html>
